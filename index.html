<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Manager</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JS for Dropdown -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #f4f6f8; font-family: sans-serif; }
        .container-fluid { max-width: 100%; padding: 0 30px; }
        
        /* Product Image */
        .product-img { 
            width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; 
            cursor: pointer; transition: transform 0.2s; background: #eee;
        }
        .product-img:hover { transform: scale(1.1); border-color: #0d6efd; }
        
        /* Status Badges */
        .status-active { color: #198754; font-weight: bold; background: #d1e7dd; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }
        .status-draft { color: #6c757d; font-weight: bold; background: #e2e3e5; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }

        /* Sticky Header */
        .sticky-header-wrapper {
            position: sticky; top: 0; z-index: 1020;
            background-color: #f4f6f8;
            padding-top: 15px; padding-bottom: 10px;
            box-shadow: 0 4px 6px -4px rgba(0,0,0,0.1);
        }

        /* Inventory Grid */
        .inv-grid-container { display: flex; flex-wrap: wrap; gap: 4px; width: 100%; }
        .inv-item {
            flex: 0 0 calc(25% - 4px); background: #fff; border: 1px solid #dee2e6; border-radius: 4px;
            padding: 2px; display: flex; align-items: center; justify-content: space-between; overflow: hidden;
        }
        .inv-label {
            font-size: 0.75rem; font-weight: bold; color: #555; margin-left: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 25px; cursor: help;
        }
        .inv-input { 
            width: 32px; text-align: center; border: none; background: #f8f9fa;
            font-size: 0.85rem; font-weight: bold; padding: 1px; margin-left: 2px; border-radius: 2px;
        }
        .inv-input:focus { outline: 2px solid #86b7fe; background: #fff; }
        .inv-dirty { background-color: #fff3cd !important; color: #856404; } 

        /* Loader & Load More */
        #ajax-loader-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 4px;
            background-color: #e9ecef; z-index: 9999; display: none; overflow: hidden;
        }
        .bar-indeterminate {
            background-color: #0d6efd; height: 100%; width: 100%;
            animation: indeterminateAnimation 1.5s infinite linear; transform-origin: 0% 50%;
        }
        @keyframes indeterminateAnimation {
            0% { transform:  translateX(0) scaleX(0); }
            40% { transform:  translateX(0) scaleX(0.4); }
            100% { transform:  translateX(100%) scaleX(0.5); }
        }
        #load-more-container { text-align: center; margin: 20px 0 50px 0; }
        .load-more-btn { padding: 10px 30px; font-weight: bold; }
        
        #click-blocker {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: transparent; z-index: 9998; display: none; cursor: progress;
        }
        
        /* Modals */
        #imageModal, #confirmModal {
            display: none; position: fixed; z-index: 3000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85);
            backdrop-filter: blur(4px); justify-content: center; align-items: center;
        }
        /* Modal Image now bigger */
        #modalImg { 
            max-width: 95%; max-height: 95%; border-radius: 4px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: none; /* Initially hidden until loaded */
        }
        #modalLoader {
            width: 3rem; height: 3rem; color: white;
        }
        .close-modal { position: absolute; top: 20px; right: 30px; color: #fff; font-size: 50px; cursor: pointer; z-index: 3001; }
        .confirm-box { background: white; padding: 30px; border-radius: 12px; width: 450px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }

        /* Helper Links & Custom Dropdown */
        .helper-link { cursor: pointer; font-size: 0.9rem; text-decoration: none; margin-right: 12px; font-weight: 500; }
        .helper-link:hover { text-decoration: underline; }
        
        /* Collection Dropdown Custom Style */
        .collection-dropdown-menu { width: 100%; max-height: 350px; overflow-y: auto; padding: 0; }
        .collection-search-box { position: sticky; top: 0; background: white; padding: 10px; border-bottom: 1px solid #eee; z-index: 10; }
        .dropdown-item { cursor: pointer; padding: 8px 15px; font-size: 0.9rem; border-bottom: 1px solid #f8f9fa; }
        .dropdown-item:hover { background-color: #e9ecef; }
        .dropdown-item.active-col { background-color: #e7f1ff; color: #0d6efd; font-weight: bold; }
    </style>
</head>
<body>

    <div id="ajax-loader-bar"><div class="bar-indeterminate"></div></div>
    <div id="click-blocker"></div> 

    <!-- IMAGE PREVIEW MODAL WITH LOADER -->
    <div id="imageModal" onclick="this.style.display='none'">
        <span class="close-modal">&times;</span>
        <!-- Spinner -->
        <div id="modalLoader" class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <img id="modalImg">
    </div>

    <div id="confirmModal">
        <div class="confirm-box">
            <h4 id="modalTitle" class="mb-3 fw-bold text-dark">Confirm</h4>
            <p id="confirmMessage" class="text-secondary mb-4">Are you sure?</p>
            <div class="d-flex justify-content-center gap-3">
                <button id="confirmCancelBtn" class="btn btn-light border px-4" onclick="closeConfirmModal()">Cancel</button>
                <button id="confirmYesBtn" class="btn btn-primary px-4">Yes</button>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="sticky-header-wrapper">
            <div class="d-flex justify-content-between align-items-center mb-2 p-3 bg-white shadow-sm rounded">
                <h4 class="m-0">Shopify Manager</h4>
                <div class="d-flex align-items-center gap-2">
                    <button id="btnSaveInventory" class="btn btn-warning btn-sm fw-bold shadow-sm" style="display:none;" onclick="saveInventoryChanges()">
                        ðŸ’¾ SAVE CHANGES
                    </button>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body p-3">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-muted mb-1">Search Products</label>
                            <div class="input-group input-group-sm">
                                <input type="text" id="storeSearch" class="form-control" placeholder="Search Title, SKU..." onkeyup="if(event.key === 'Enter') initSearch()">
                                <button class="btn btn-primary" type="button" onclick="initSearch()">Search</button>
                            </div>
                        </div>
                        
                        <!-- CUSTOM COLLECTION DROPDOWN -->
                        <div class="col-md-4">
                            <label class="form-label fw-bold small text-muted mb-1">Select Collection</label>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm w-100 dropdown-toggle text-start d-flex justify-content-between align-items-center" 
                                        type="button" id="collectionDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                                    <span>-- Select Collection --</span>
                                </button>
                                <div class="dropdown-menu collection-dropdown-menu shadow" aria-labelledby="collectionDropdownBtn">
                                    <div class="collection-search-box">
                                        <input type="text" class="form-control form-control-sm" id="collectionSearchInput" 
                                               placeholder="Type to search collection..." onkeyup="filterCollectionList()">
                                    </div>
                                    <div id="collectionListContainer">
                                        <div class="p-3 text-center text-muted small">Loading collections...</div>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="selectedCollectionId">
                        </div>

                        <!-- SORT DROPDOWN -->
                        <div class="col-md-2">
                            <label class="form-label fw-bold small text-muted mb-1">Sort Products</label>
                            <select id="sortSelect" class="form-select form-select-sm" onchange="renderGrid()">
                                <option value="newest">Date: New to Old</option>
                                <option value="oldest">Date: Old to New</option>
                                <option value="active_first">Status: Active First</option>
                                <option value="draft_first">Status: Draft First</option>
                            </select>
                        </div>

                        <div class="col-md-3 d-flex gap-2 justify-content-end align-items-end">
                            <button class="btn btn-sm btn-success" onclick="initUpdateStatus('active')">Set Active</button>
                            <button class="btn btn-sm btn-secondary" onclick="initUpdateStatus('draft')">Set Draft</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="initLoadCollection()">â†» Refresh</button>
                        </div>
                    </div>
                    
                    <!-- QUICK SELECT ROW -->
                    <div class="d-flex justify-content-between mt-3 align-items-center border-top pt-2">
                        <div class="small d-flex align-items-center">
                            <strong class="me-2">Quick Select: </strong>
                            <span class="helper-link text-primary" onclick="selectByStatus('all')">All</span>
                            <span class="helper-link text-success" onclick="selectByStatus('active')">Active</span>
                            <span class="helper-link text-secondary" onclick="selectByStatus('draft')">Draft</span>
                            <span class="helper-link text-danger" onclick="selectByStatus('none')">None</span>
                        </div>
                        <div class="fw-bold text-muted small">
                            Loaded: <span id="productCount" class="text-dark">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mt-3 mb-2">
            <div class="card-body p-0">
                <table class="table table-hover table-bordered m-0 align-middle table-sm">
                    <thead class="table-dark text-center">
                        <tr>
                            <th width="40"><input type="checkbox" id="selectAll" class="form-check-input" onclick="toggleSelectAll()"></th>
                            <th width="60">Image</th>
                            <th class="text-start">Product Title</th>
                            <th width="280">Inventory</th> 
                            <th width="120">SKU</th>
                            <th width="100">Type</th>
                            <th width="80">Status</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <tr><td colspan="7" class="text-center py-5 text-muted">Select a collection or Search to start.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="load-more-container" style="display:none;">
             <button class="btn btn-outline-primary load-more-btn" onclick="loadMoreProducts()">â¬‡ Load More Products</button>
        </div>
    </div>

    <script>
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzyfwn3QM5HTtkWACf7V6eto14AMrQmRG2zznKaEXyBNmCodqpuQuagVjhv2BweRhkMeg/exec"; 

        // State Variables
        let currentCursor = null;
        let hasMoreData = false;
        let currentMode = 'collection'; 
        let currentQueryOrId = '';
        
        let globalProducts = [];
        let globalCollections = []; // Store for filtering
        let pendingInventory = {}; 

        window.onload = function() {
            if(!GAS_WEB_APP_URL.includes("/exec")) return alert("Invalid URL!");
            fetchCollections();
        };

        function showLoader(show) {
            const bar = document.getElementById('ajax-loader-bar');
            const blocker = document.getElementById('click-blocker');
            bar.style.display = show ? 'block' : 'none';
            blocker.style.display = show ? 'block' : 'none';
        }

        // --- COLLECTION DROPDOWN LOGIC ---
        function filterCollectionList() {
            const filter = document.getElementById('collectionSearchInput').value.toLowerCase();
            const container = document.getElementById('collectionListContainer');
            container.innerHTML = ""; // Clear current

            const filtered = globalCollections.filter(c => c.title.toLowerCase().includes(filter));
            
            if(filtered.length === 0) {
                container.innerHTML = `<div class="p-3 text-center text-muted">No collections found</div>`;
                return;
            }

            filtered.forEach(c => {
                const div = document.createElement('div');
                div.className = "dropdown-item";
                div.innerText = c.title;
                div.onclick = function() { selectCollection(c.id, c.title); };
                container.appendChild(div);
            });
        }

        function selectCollection(id, title) {
            document.getElementById('selectedCollectionId').value = id;
            document.getElementById('collectionDropdownBtn').innerHTML = `<span>${title}</span>`;
            initLoadCollection();
        }

        // --- FETCHING LOGIC ---

        async function initLoadCollection() {
            const id = document.getElementById('selectedCollectionId').value;
            if(!id) return; 
            resetGrid();
            currentMode = 'collection';
            currentQueryOrId = id;
            document.getElementById('storeSearch').value = ""; 
            await fetchProducts();
        }

        async function initSearch() {
            const query = document.getElementById('storeSearch').value;
            if(!query) return alert("Enter search term");
            resetGrid();
            currentMode = 'search';
            currentQueryOrId = query;
            document.getElementById('selectedCollectionId').value = "";
            document.getElementById('collectionDropdownBtn').innerHTML = `<span>-- Select Collection --</span>`;
            await fetchProducts();
        }

        function resetGrid() {
            document.getElementById('productTableBody').innerHTML = "";
            document.getElementById('productCount').innerText = "0";
            document.getElementById('load-more-container').style.display = 'none';
            currentCursor = null;
            hasMoreData = false;
            globalProducts = [];
        }

        async function loadMoreProducts() {
            if(!hasMoreData) return;
            await fetchProducts();
        }

        async function fetchProducts() {
            showLoader(true);
            
            const payload = { 
                action: currentMode === 'collection' ? 'getProducts' : 'searchStore',
                cursor: currentCursor
            };
            
            if(currentMode === 'collection') payload.collectionId = currentQueryOrId;
            else payload.query = currentQueryOrId;

            const result = await callAPI(payload);
            
            if (result.success) {
                currentCursor = result.nextCursor;
                hasMoreData = result.hasNextPage;
                
                if(result.products.length > 0) {
                    globalProducts = globalProducts.concat(result.products);
                    renderGrid(); // Render all with sort
                    document.getElementById('productCount').innerText = globalProducts.length;
                } else if(globalProducts.length === 0) {
                    document.getElementById('productTableBody').innerHTML = `<tr><td colspan="7" class="text-center py-5 text-muted">No products found.</td></tr>`;
                }

                const btnContainer = document.getElementById('load-more-container');
                btnContainer.style.display = hasMoreData ? 'block' : 'none';
            } else {
                alert("Error: " + (result.message || "Unknown error"));
            }
            showLoader(false);
        }

        function renderGrid() {
            const sortMode = document.getElementById('sortSelect').value;
            const tbody = document.getElementById('productTableBody');
            
            // Sort Global Products
            globalProducts.sort((a, b) => {
                if (sortMode === 'newest') return 0; // Default backend order (reverse:true)
                if (sortMode === 'oldest') return 0; 
                
                if (sortMode === 'active_first') return (a.status === b.status) ? 0 : (a.status === 'active' ? -1 : 1);
                if (sortMode === 'draft_first') return (a.status === b.status) ? 0 : (a.status === 'draft' ? -1 : 1);
                return 0;
            });

            // Special handling for Oldest (Reverse the array temporarily for display)
            let displayProducts = [...globalProducts];
            if (sortMode === 'oldest') {
                displayProducts.reverse();
            }

            const html = displayProducts.map(p => {
                let thumbSrc = p.image ? p.image.src : 'https://placehold.co/50';
                let largeSrc = p.image ? p.image.large : 'https://placehold.co/800';
                
                let statusClass = p.status === 'active' ? 'status-active' : 'status-draft';
                let sku = (p.variants && p.variants[0]) ? p.variants[0].sku : '-';
                
                let inventoryHtml = '<div class="inv-grid-container">';
                if(p.variants && p.variants.length > 0) {
                    p.variants.forEach(v => {
                        let label = v.title === 'Default Title' ? 'Qty' : v.title;
                        inventoryHtml += `
                            <div class="inv-item" title="${label}">
                                <span class="inv-label">${label}</span>
                                <input type="number" class="inv-input" data-iid="${v.inventory_item_id}" value="${v.inventory_quantity}" onchange="trackInventoryChange(this, '${v.inventory_item_id}')">
                            </div>`;
                    });
                }
                inventoryHtml += '</div>';

                return `
                    <tr>
                        <td class="text-center"><input type="checkbox" class="product-check form-check-input" value="${p.id}"></td>
                        <td class="text-center"><img src="${thumbSrc}" class="product-img" loading="lazy" onclick="viewImage('${largeSrc}')"></td>
                        <td class="fw-bold text-dark small">${p.title}</td>
                        <td style="vertical-align: top;">${inventoryHtml}</td>
                        <td class="small font-monospace text-secondary">${sku}</td>
                        <td class="small text-secondary">${p.product_type}</td>
                        <td class="text-center"><span class="${statusClass}">${p.status.toUpperCase()}</span></td>
                    </tr>`;
            }).join('');

            tbody.innerHTML = html;
        }

        // --- QUICK SELECT ---
        function selectByStatus(type) {
            document.querySelectorAll('.product-check').forEach(cb => {
                const row = cb.closest('tr');
                const statusSpan = row.querySelector('td:last-child span');
                const status = statusSpan ? statusSpan.innerText.toLowerCase() : '';
                
                if (type === 'all') cb.checked = true;
                else if (type === 'none') cb.checked = false;
                else if (type === 'active' && status === 'active') cb.checked = true;
                else if (type === 'draft' && status === 'draft') cb.checked = true;
            });
        }

        // --- INVENTORY & UTILS ---
        function trackInventoryChange(input, invItemId) {
            input.classList.add('inv-dirty');
            pendingInventory[invItemId] = input.value;
            document.getElementById('btnSaveInventory').style.display = 'inline-block';
        }

        async function saveInventoryChanges() {
            const updates = Object.keys(pendingInventory).map(iid => {
                return { inventoryItemId: iid, quantity: pendingInventory[iid] };
            });
            if(updates.length === 0) return;

            showLoader(true);
            const result = await callAPI({ action: 'updateInventory', updates: updates });

            if(result.success) {
                updates.forEach(u => {
                    const inputs = document.querySelectorAll(`input[data-iid="${u.inventoryItemId}"]`);
                    inputs.forEach(inp => inp.classList.remove('inv-dirty'));
                });
                pendingInventory = {};
                document.getElementById('btnSaveInventory').style.display = 'none';
                alert("Inventory Saved!");
            } else {
                alert("Failed: " + JSON.stringify(result));
            }
            showLoader(false);
        }

        async function fetchCollections() {
            const result = await callAPI({ action: 'getCollections' });
            if (result.success) {
                globalCollections = result.collections; // Store globally
                filterCollectionList(); // Render initial list
            }
        }

        async function updateStatus(newStatus) {
            const checkboxes = document.querySelectorAll('.product-check:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);
            showLoader(true);
            const result = await callAPI({ action: 'updateStatus', ids: ids, status: newStatus });
            if (result.success) {
                ids.forEach(id => {
                   const checkbox = document.querySelector(`input[value="${id}"]`);
                   if(checkbox) {
                       const row = checkbox.closest('tr');
                       const badge = row.querySelector('td:last-child span');
                       badge.className = newStatus === 'active' ? 'status-active' : 'status-draft';
                       badge.innerText = newStatus.toUpperCase();
                   }
                });
                renderGrid();
            }
            showLoader(false);
        }

        function initUpdateStatus(status) {
            const count = document.querySelectorAll('.product-check:checked').length;
            if(count === 0) return alert("Select products first");
            if(confirm(`Set ${count} products to ${status}?`)) updateStatus(status);
        }
        
        // --- UPDATED VIEW IMAGE WITH SPINNER ---
        function viewImage(url) { 
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('modalImg');
            const loader = document.getElementById('modalLoader');

            // Show modal, show loader, hide previous image
            modal.style.display = "flex"; 
            loader.style.display = "block";
            img.style.display = "none";
            
            // Set source
            img.src = url;

            // When loaded, hide loader and show image
            img.onload = function() {
                loader.style.display = "none";
                img.style.display = "block";
            };
        }

        function toggleSelectAll() { 
            const main = document.getElementById('selectAll'); 
            if(event.target.id !== 'selectAll') main.checked = !main.checked;
            document.querySelectorAll('.product-check').forEach(cb => cb.checked = main.checked); 
        }
        function closeConfirmModal() { document.getElementById('confirmModal').style.display = 'none'; }
        
        async function callAPI(payload) {
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: "POST", body: JSON.stringify(payload),
                    headers: { "Content-Type": "text/plain" }
                });
                return await response.json();
            } catch (error) {
                return { error: true, message: error.message };
            }
        }
    </script>
</body>
</html>
