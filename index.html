<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Advanced Manager</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background-color: #f4f6f8; font-family: sans-serif; }
        .container-fluid { max-width: 100%; padding: 0 30px; }
        .product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; transition: transform 0.2s; }
        .product-img:hover { transform: scale(1.1); border-color: #0d6efd; }
        .status-active { color: #198754; font-weight: bold; background: #d1e7dd; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }
        .status-draft { color: #6c757d; font-weight: bold; background: #e2e3e5; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }

        .sticky-header-wrapper {
            position: sticky; top: 0; z-index: 1020;
            background-color: #f4f6f8;
            padding-top: 15px; padding-bottom: 10px;
            box-shadow: 0 4px 6px -4px rgba(0,0,0,0.1);
        }

        #imageModal, #confirmModal {
            display: none; position: fixed; z-index: 3000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);
            justify-content: center; align-items: center;
        }
        #modalImg { max-width: 90%; max-height: 90%; border-radius: 8px; }
        .close-modal { position: absolute; top: 20px; right: 30px; color: #f1f1f1; font-size: 40px; cursor: pointer; }
        .confirm-box { background: white; padding: 25px; border-radius: 8px; width: 400px; text-align: center; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 2000; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        #error-display { display: none; position: fixed; bottom: 20px; right: 20px; max-width: 400px; z-index: 2100; }
        .helper-link { cursor: pointer; font-size: 0.85rem; text-decoration: none; margin-right: 8px; }
        .helper-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <div id="imageModal" onclick="this.style.display='none'">
        <span class="close-modal">&times;</span>
        <img id="modalImg">
    </div>

    <div id="confirmModal">
        <div class="confirm-box">
            <h5 class="mb-3">Confirm Action</h5>
            <p id="confirmMessage" class="text-muted mb-4">Are you sure?</p>
            <div class="d-flex justify-content-center gap-2">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                <button id="confirmYesBtn" class="btn btn-primary">Yes, Proceed</button>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="sticky-header-wrapper">
            <div class="d-flex justify-content-between align-items-center mb-2 p-3 bg-white shadow-sm rounded">
                <h4 class="m-0">Shopify Manager <small class="text-muted fs-6">| Active Viewer</small></h4>
                <div><span class="badge bg-primary">External Hosted</span></div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body p-3">
                    <div class="row g-3 align-items-end">
                        
                        <div class="col-md-5">
                            <label class="form-label fw-bold small text-muted mb-1">Global Search / Active / Collection</label>
                            
                            <!-- Search & Active Button -->
                            <div class="input-group input-group-sm mb-2">
                                <input type="text" id="storeSearch" class="form-control" placeholder="Search Title, SKU...">
                                <button class="btn btn-primary" type="button" onclick="searchStore()">Search</button>
                                <!-- NEW BUTTON -->
                                <button class="btn btn-info text-white fw-bold" type="button" onclick="loadActiveProducts()">Show All Active</button>
                            </div>

                            <select id="collectionSelect" class="form-select form-select-sm" onchange="loadProducts()">
                                <option value="" selected disabled>-- Or Select Collection --</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label fw-bold small text-muted mb-1">Sort Products</label>
                            <select id="sortSelect" class="form-select form-select-sm" onchange="sortAndRender()">
                                <option value="newest">Date: New to Old</option>
                                <option value="oldest">Date: Old to New</option>
                                <option value="active_first">Status: Active First</option>
                                <option value="draft_first">Status: Draft First</option>
                            </select>
                        </div>

                        <div class="col-md-5 d-flex gap-2 justify-content-end">
                            <button class="btn btn-sm btn-success" onclick="askConfirmation('active')">Set Active</button>
                            <button class="btn btn-sm btn-secondary" onclick="askConfirmation('draft')">Set Draft</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadProducts()">â†» Refresh</button>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-2 align-items-center">
                        <div class="small">
                            <strong>Quick Select: </strong>
                            <span class="helper-link text-primary" onclick="selectByStatus('all')">All</span>
                            <span class="helper-link text-success" onclick="selectByStatus('active')">Active</span>
                            <span class="helper-link text-secondary" onclick="selectByStatus('draft')">Draft</span>
                            <span class="helper-link text-danger" onclick="selectByStatus('none')">None</span>
                        </div>
                        <div class="fw-bold text-muted small">
                            Total: <span id="productCount" class="text-dark">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mt-3 mb-5">
            <div class="card-body p-0">
                <table class="table table-hover table-bordered m-0 align-middle table-sm">
                    <thead class="table-dark text-center">
                        <tr>
                            <th width="40"><input type="checkbox" id="selectAll" class="form-check-input" onclick="toggleSelectAll()"></th>
                            <th width="70">Image</th>
                            <th class="text-start">Product Title</th>
                            <th width="150">SKU</th>
                            <th width="120">Type</th>
                            <th width="100">Status</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <tr><td colspan="6" class="text-center py-5 text-muted">Select a collection, Search, or click "Show All Active".</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="error-display" class="alert alert-danger shadow-lg">
        <strong>Error:</strong> <span id="error-text"></span>
        <button class="btn-close ms-2" onclick="this.parentElement.style.display='none'"></button>
    </div>
    <div class="loading-overlay" id="loader">
        <div class="spinner-border text-primary" role="status"></div>
        <h5 class="mt-3" id="loaderText">Processing...</h5>
    </div>

    <script>
        // ******************************************************
        // Apnar New Deployed URL Ekhane Din
        // ******************************************************
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzyfwn3QM5HTtkWACf7V6eto14AMrQmRG2zznKaEXyBNmCodqpuQuagVjhv2BweRhkMeg/exec"; 

        let globalCollections = []; 
        let globalProducts = [];    

        window.onload = function() {
            if(!GAS_WEB_APP_URL.includes("/exec")) return showError("Invalid URL! Must end with /exec");
            fetchCollections();
        };

        // --- NEW: Load Active Products ---
        async function loadActiveProducts() {
            // UI Reset
            document.getElementById('storeSearch').value = "";
            document.getElementById('collectionSelect').value = "";
            
            showLoader(true, "Fetching All Active Products...");
            document.getElementById('productTableBody').innerHTML = '<tr><td colspan="6" class="text-center py-5">Loading active products...</td></tr>';
            
            // Backend Call
            const result = await callAPI('getAllActive');
            
            if (result.success && result.products) {
                globalProducts = result.products;
                sortAndRender(); 
            } else {
                document.getElementById('productTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load active products.</td></tr>';
                document.getElementById('productCount').innerText = "0";
            }
            showLoader(false);
        }

        // --- Search Logic ---
        async function searchStore() {
            const query = document.getElementById('storeSearch').value;
            if(!query) return alert("Please enter text to search.");

            document.getElementById('collectionSelect').value = "";
            showLoader(true, "Searching Global Store...");
            
            const result = await callAPI('searchStore', { query: query });
            
            if (result.success && result.products) {
                globalProducts = result.products;
                sortAndRender(); 
            } else {
                document.getElementById('productTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-danger">No products found.</td></tr>';
                document.getElementById('productCount').innerText = "0";
            }
            showLoader(false);
        }

        // --- Common Logic ---
        function viewImage(url) {
            document.getElementById('modalImg').src = url;
            document.getElementById('imageModal').style.display = "flex";
        }

        function askConfirmation(status) {
            const checkboxes = document.querySelectorAll('.product-check:checked');
            if (checkboxes.length === 0) return alert("Please select products first.");
            document.getElementById('confirmMessage').innerText = `Set ${checkboxes.length} products to ${status.toUpperCase()}?`;
            document.getElementById('confirmModal').style.display = "flex";
            document.getElementById('confirmYesBtn').onclick = function() { closeConfirmModal(); updateStatus(status); };
        }
        function closeConfirmModal() { document.getElementById('confirmModal').style.display = "none"; }

        function selectByStatus(type) {
            document.querySelectorAll('.product-check').forEach(cb => {
                const row = cb.closest('tr');
                const status = row.querySelector('td:last-child span').innerText.toLowerCase();
                if (type === 'all') cb.checked = true;
                else if (type === 'none') cb.checked = false;
                else if (type === 'active' && status === 'active') cb.checked = true;
                else if (type === 'draft' && status === 'draft') cb.checked = true;
            });
        }

        async function fetchCollections() {
            showLoader(true, "Fetching Collections...");
            const result = await callAPI('getCollections');
            if (result.success) {
                globalCollections = result.collections;
                const select = document.getElementById('collectionSelect');
                globalCollections.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id; opt.text = c.title; select.appendChild(opt);
                });
            }
            showLoader(false);
        }

        async function loadProducts() {
            const collectionId = document.getElementById('collectionSelect').value;
            if (!collectionId) return;
            document.getElementById('storeSearch').value = "";
            showLoader(true, "Loading Products...");
            const result = await callAPI('getProducts', { collectionId: collectionId });
            if (result.success) { globalProducts = result.products; sortAndRender(); }
            showLoader(false);
        }

        function sortAndRender() {
            const sortMode = document.getElementById('sortSelect').value;
            const tbody = document.getElementById('productTableBody');
            const countSpan = document.getElementById('productCount');
            
            if(globalProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No products found.</td></tr>';
                countSpan.innerText = "0";
                return;
            }

            globalProducts.sort((a, b) => {
                if (sortMode === 'newest') return new Date(b.created_at) - new Date(a.created_at);
                if (sortMode === 'oldest') return new Date(a.created_at) - new Date(b.created_at);
                if (sortMode === 'active_first') return (a.status === b.status) ? 0 : (a.status === 'active' ? -1 : 1);
                if (sortMode === 'draft_first') return (a.status === b.status) ? 0 : (a.status === 'draft' ? -1 : 1);
                return 0;
            });

            tbody.innerHTML = '';
            countSpan.innerText = globalProducts.length;

            globalProducts.forEach(p => {
                let imgSrc = p.image ? p.image.src : 'https://placehold.co/60';
                let statusClass = p.status === 'active' ? 'status-active' : 'status-draft';
                let sku = (p.variants && p.variants[0]) ? p.variants[0].sku : '-';
                let type = p.product_type || '-';

                let row = `
                    <tr>
                        <td class="text-center"><input type="checkbox" class="product-check form-check-input" value="${p.id}"></td>
                        <td class="text-center"><img src="${imgSrc}" class="product-img" onclick="viewImage('${imgSrc}')"></td>
                        <td class="fw-bold text-dark">${p.title}</td>
                        <td class="small font-monospace text-secondary">${sku}</td>
                        <td class="small text-secondary">${type}</td>
                        <td class="text-center"><span class="${statusClass}">${p.status.toUpperCase()}</span></td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }

        async function updateStatus(newStatus) {
            const checkboxes = document.querySelectorAll('.product-check:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);
            showLoader(true, "Updating...");
            const result = await callAPI('updateStatus', { ids: ids, status: newStatus });
            if (result.success) {
                globalProducts.forEach(p => { if(ids.includes(p.id.toString())) p.status = newStatus; });
                sortAndRender();
            }
            showLoader(false);
        }

        async function callAPI(action, payload) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); 
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: "POST", body: JSON.stringify({ action, ...payload }),
                    headers: { "Content-Type": "text/plain" }, signal: controller.signal
                });
                clearTimeout(timeoutId);
                return await response.json();
            } catch (error) {
                console.error(error);
                showError(error.name === 'AbortError' ? "Timeout! Request took too long." : error.message);
                return { error: true };
            }
        }

        function showLoader(show, text) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
            if(text) document.getElementById('loaderText').innerText = text;
        }
        function showError(msg) {
            document.getElementById('error-text').innerText = msg;
            document.getElementById('error-display').style.display = 'block';
        }
        function toggleSelectAll() {
            const main = document.getElementById('selectAll');
            document.querySelectorAll('.product-check').forEach(cb => cb.checked = main.checked);
        }
    </script>
</body>
</html>
