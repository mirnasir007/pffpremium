<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Draft Manager</title>
    
    <!-- PWA / Mobile App Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f4f6f8">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f4f6f8; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Responsive Container */
        .container-fluid { max-width: 100%; padding: 0 15px; }
        @media (min-width: 768px) { .container-fluid { padding: 0 30px; } }
        
        /* Images */
        .product-img { width: 45px; height: 45px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; transition: transform 0.2s; }
        .product-img:hover { transform: scale(1.1); border-color: #0d6efd; }
        
        /* Status Badges */
        .status-active { color: #198754; font-weight: bold; background: #d1e7dd; padding: 3px 6px; border-radius: 4px; font-size: 0.7rem; display: inline-block; white-space: nowrap; }
        .status-draft { color: #6c757d; font-weight: bold; background: #e2e3e5; padding: 3px 6px; border-radius: 4px; font-size: 0.7rem; display: inline-block; white-space: nowrap; }

        /* Sticky Header */
        .sticky-header-wrapper { 
            position: sticky; top: 0; z-index: 1020; 
            background-color: #f4f6f8; 
            padding-top: 10px; padding-bottom: 5px; 
            box-shadow: 0 4px 6px -4px rgba(0,0,0,0.1); 
        }
        
        .helper-link { cursor: pointer; font-size: 0.8rem; text-decoration: none; margin-right: 8px; white-space: nowrap; }
        
        /* Custom Modals */
        #imageModal, #confirmModal, #alertModal { 
            display: none; position: fixed; z-index: 3000; left: 0; top: 0; 
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); 
            backdrop-filter: blur(2px); justify-content: center; align-items: center; 
        }
        #modalImg { max-width: 95%; max-height: 80vh; border-radius: 8px; object-fit: contain; }
        
        .confirm-box { 
            background: white; padding: 25px; border-radius: 12px; 
            width: 90%; max-width: 400px; 
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            animation: popIn 0.2s ease-out; margin: auto;
        }
        @keyframes popIn { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        /* Inventory Grid */
        .inv-grid-container { display: flex; flex-wrap: wrap; gap: 4px; width: 100%; }
        .inv-item { 
            flex: 0 0 calc(33.33% - 4px); /* 3 items per row on mobile */
            background: #fff; border: 1px solid #dee2e6; border-radius: 4px; 
            padding: 2px; display: flex; align-items: center; justify-content: center; 
            overflow: hidden; 
        }
        @media (min-width: 768px) { .inv-item { flex: 0 0 calc(25% - 4px); } }

        .inv-label { font-size: 0.7rem; font-weight: bold; color: #555; margin-right: 3px; max-width: 30px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: none; }
        @media (min-width: 768px) { .inv-label { display: block; } }

        .inv-input { 
            width: 100%; height: 32px; text-align: center; border: none; 
            background: #f8f9fa; font-size: 1rem; font-weight: bold; 
            padding: 0; border-radius: 2px; 
        }
        .inv-input:focus { outline: 2px solid #86b7fe; background: #fff; }
        .inv-dirty { background-color: #fff3cd !important; color: #856404; }

        /* --- MOBILE CARD VIEW CSS (Magic Happens Here) --- */
        @media (max-width: 768px) {
            /* Hide the table header completely on mobile */
            thead { display: none; }

            /* Turn rows into Cards */
            tbody tr {
                display: flex;
                flex-wrap: wrap;
                background: #fff;
                margin-bottom: 12px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 10px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                position: relative;
                align-items: center;
            }

            /* Reset cell styles */
            tbody td {
                border: none !important;
                padding: 2px 4px !important;
                display: block;
            }

            /* 1. Checkbox (Left) */
            tbody td:nth-child(1) { width: 30px; order: 1; }
            
            /* 2. Image (Next to Checkbox) */
            tbody td:nth-child(2) { width: 55px; order: 2; }
            
            /* 3. Title (Middle - Takes remaining space) */
            tbody td:nth-child(3) { 
                width: calc(100% - 165px); /* Full width minus check, img, status */
                order: 3; 
                font-weight: bold; 
                line-height: 1.2;
            }

            /* 4. Status (Right Top) */
            tbody td:nth-child(7) { 
                width: 80px; 
                order: 4; 
                text-align: right;
            }

            /* 5. SKU (New Row - Left) */
            tbody td:nth-child(5) { 
                width: 50%; 
                order: 5; 
                font-size: 0.8rem; 
                color: #666; 
                margin-top: 5px;
                padding-left: 35px !important; /* Indent to align with image */
            }
            tbody td:nth-child(5)::before { content: "SKU: "; font-weight: bold; opacity: 0.7; }

            /* 6. Type (New Row - Right) */
            tbody td:nth-child(6) { 
                width: 50%; 
                order: 6; 
                text-align: right; 
                font-size: 0.8rem; 
                color: #666; 
                margin-top: 5px; 
            }

            /* 7. Inventory (Bottom Full Width) */
            tbody td:nth-child(4) { 
                width: 100%; 
                order: 7; 
                margin-top: 8px; 
                border-top: 1px dashed #eee !important;
                padding-top: 8px !important;
            }
        }

        /* Loader */
        #ajax-loader-bar { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background-color: #e9ecef; z-index: 9999; display: none; }
        .bar-indeterminate { background-color: #0d6efd; height: 100%; width: 100%; animation: indeterminateAnimation 1.5s infinite linear; transform-origin: 0% 50%; }
        @keyframes indeterminateAnimation { 0% { transform: translateX(0) scaleX(0); } 40% { transform: translateX(0) scaleX(0.4); } 100% { transform: translateX(100%) scaleX(0.5); } }
        #click-blocker { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 9998; display: none; cursor: progress; }

        .fs-7 { font-size: 0.85rem; }
    </style>
</head>
<body>

    <div id="ajax-loader-bar"><div class="bar-indeterminate"></div></div>
    <div id="click-blocker"></div> 

    <!-- Image Modal -->
    <div id="imageModal" onclick="this.style.display='none'">
        <span style="position:absolute;top:20px;right:20px;color:#fff;font-size:40px;cursor:pointer;background:rgba(0,0,0,0.3);width:40px;height:40px;line-height:35px;text-align:center;border-radius:50%;">&times;</span>
        <img id="modalImg">
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal">
        <div class="confirm-box">
            <h4 class="mb-3 fw-bold text-dark">Confirm</h4>
            <p id="confirmMessage" class="text-secondary mb-4 fs-6">Are you sure?</p>
            <div class="d-flex justify-content-center gap-2">
                <button class="btn btn-light border px-3 flex-grow-1" onclick="document.getElementById('confirmModal').style.display='none'">Cancel</button>
                <button id="confirmYesBtn" class="btn btn-primary px-3 flex-grow-1">Yes</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal">
        <div class="confirm-box">
            <h4 id="alertTitle" class="mb-3 fw-bold text-dark">Notice</h4>
            <p id="alertMessage" class="text-secondary mb-4 fs-6">...</p>
            <button class="btn btn-primary px-5 w-100" onclick="document.getElementById('alertModal').style.display='none'">OK</button>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Sticky Header -->
        <div class="sticky-header-wrapper">
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white shadow-sm rounded">
                <h5 class="m-0 fw-bold">Shopify Manager</h5>
                <div class="d-flex align-items-center gap-1">
                    <button id="btnSaveInventory" class="btn btn-warning btn-sm fw-bold shadow-sm" style="display:none;" onclick="saveInventoryChanges()">üíæ Save</button>
                    <button class="btn btn-danger btn-sm fw-bold border border-white shadow-sm" onclick="initDraftAllStore()">‚ö†Ô∏è All Draft</button>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body p-2 p-md-3">
                    <div class="row g-2 align-items-end">
                        <!-- Search & Collection -->
                        <div class="col-12 col-md-5">
                            <div class="input-group input-group-sm mb-2">
                                <input type="text" id="storeSearch" class="form-control" placeholder="Search Title, SKU...">
                                <button class="btn btn-primary" type="button" onclick="searchStore()">Search</button>
                            </div>
                            <select id="collectionSelect" class="form-select form-select-sm" onchange="loadProducts()">
                                <option value="" selected disabled>-- Select Collection --</option>
                            </select>
                        </div>
                        
                        <!-- Sort -->
                        <div class="col-6 col-md-2">
                            <label class="form-label fw-bold small text-muted mb-0 d-none d-md-block">Sort</label>
                            <select id="sortSelect" class="form-select form-select-sm" onchange="applySort()">
                                <option value="title_asc">A-Z</option>
                                <option value="active_first">Active First</option>
                                <option value="draft_first">Draft First</option>
                                <option value="newest">Newest</option>
                            </select>
                        </div>

                        <!-- Action Buttons -->
                        <div class="col-6 col-md-5 d-flex gap-1 justify-content-end align-items-end">
                            <button class="btn btn-sm btn-success flex-fill" onclick="initUpdateStatus('active')">Active</button>
                            <button class="btn btn-sm btn-secondary flex-fill" onclick="initUpdateStatus('draft')">Draft</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadProducts()">‚Üª</button>
                        </div>
                    </div>
                    
                    <!-- Quick Select Links -->
                    <div class="d-flex justify-content-between mt-2 align-items-center overflow-auto">
                        <div class="small d-flex align-items-center text-nowrap" style="overflow-x: auto; padding-bottom: 2px;">
                            <span class="fw-bold me-1">Select:</span>
                            <span class="helper-link text-primary" onclick="selectByStatus('all')">All</span>
                            <span class="helper-link text-success" onclick="selectByStatus('active')">Active</span>
                            <span class="helper-link text-secondary" onclick="selectByStatus('draft')">Draft</span>
                            <span class="helper-link text-warning fw-bold" onclick="selectByStatus('draft_stock')">Has Stock</span>
                            <span class="helper-link text-danger" onclick="selectByStatus('none')">None</span>
                        </div>
                        <div class="mt-0 text-muted small ms-2">Total: <span id="productCount" class="text-dark fw-bold">0</span></div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Mobile Optimized Table Container (No longer scrollable on mobile) -->
        <div class="card shadow-sm mt-2 mb-5 border-0">
            <div class="card-body p-0">
                <table class="table table-hover m-0 align-middle table-sm">
                    <thead class="text-center table-light">
                        <tr>
                            <th width="30"><input type="checkbox" id="selectAll" class="form-check-input" onclick="toggleSelectAll()"></th>
                            <th width="50">Image</th>
                            <th class="text-start">Title</th>
                            <th>Inventory</th> 
                            <th>SKU</th>
                            <th>Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <tr><td colspan="7" class="text-center py-5 text-muted"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // UPDATE THIS URL IF YOU RE-DEPLOY
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzyfwn3QM5HTtkWACf7V6eto14AMrQmRG2zznKaEXyBNmCodqpuQuagVjhv2BweRhkMeg/exec"; 
        
        let globalProducts = [];
        let pendingInventory = {};

        window.onload = function() { fetchCollections(); };
        function showLoader(show) { document.getElementById('ajax-loader-bar').style.display = show?'block':'none'; document.getElementById('click-blocker').style.display = show?'block':'none'; }

        function showCustomAlert(msg, title="Notice") {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerText = msg;
            document.getElementById('alertModal').style.display = 'flex';
        }

        async function searchStore() {
            const query = document.getElementById('storeSearch').value;
            if(!query) return showCustomAlert("Please enter text.");
            showLoader(true);
            const res = await callAPI('searchStore', { query: query });
            if (res.success) { 
                globalProducts = res.products;
                applySort(); 
            }
            showLoader(false);
        }

        async function fetchCollections() {
            const res = await callAPI('getCollections');
            if (res.success) {
                const sel = document.getElementById('collectionSelect');
                res.collections.forEach(c => {
                    const opt = document.createElement('option'); opt.value = c.id; opt.text = c.title; sel.appendChild(opt);
                });
            }
        }

        async function loadProducts() {
            const cid = document.getElementById('collectionSelect').value;
            if(!cid) return;
            showLoader(true);
            const res = await callAPI('getProducts', { collectionId: cid });
            if (res.success) { 
                globalProducts = res.products;
                applySort(); 
            }
            showLoader(false);
        }

        async function updateStatus(newStatus) {
            const ids = Array.from(document.querySelectorAll('.product-check:checked')).map(cb => cb.value);
            showLoader(true);
            const res = await callAPI('updateStatus', { ids: ids, status: newStatus });
            if (res.success) {
                showCustomAlert("Updated!");
                if(newStatus === 'draft') {
                     const q = document.getElementById('storeSearch').value;
                     if(q) searchStore(); else loadProducts();
                } else {
                     globalProducts.forEach(p => { if(ids.includes(p.id)) p.status = newStatus; });
                     applySort();
                }
            }
            showLoader(false);
        }

        async function saveInventoryChanges() {
            const updates = Object.keys(pendingInventory).map(iid => ({ inventoryItemId: iid, quantity: pendingInventory[iid] }));
            showLoader(true);
            const res = await callAPI('updateInventory', { updates: updates });
            if(res.success) {
                showCustomAlert("Inventory Saved!");
                pendingInventory = {};
                document.getElementById('btnSaveInventory').style.display = 'none';
                document.querySelectorAll('.inv-dirty').forEach(el => el.classList.remove('inv-dirty'));
            } else {
                showCustomAlert("Failed: " + (res.message || ""));
            }
            showLoader(false);
        }

        function applySort() {
            const mode = document.getElementById('sortSelect').value;
            let sorted = [...globalProducts];

            if(mode === 'title_asc') {
                sorted.sort((a,b) => a.title.localeCompare(b.title));
            } else if (mode === 'active_first') {
                sorted.sort((a,b) => (a.status === b.status) ? 0 : (a.status === 'active' ? -1 : 1));
            } else if (mode === 'draft_first') {
                sorted.sort((a,b) => (a.status === b.status) ? 0 : (a.status === 'draft' ? -1 : 1));
            } else if (mode === 'newest') {
                if(sorted[0] && sorted[0].created_at) {
                    sorted.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
                }
            }
            renderProducts(sorted);
        }

        function renderProducts(products) {
            const tbody = document.getElementById('productTableBody');
            document.getElementById('productCount').innerText = products.length;
            
            if(products.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-5">No products.</td></tr>`;
                return;
            }

            tbody.innerHTML = products.map(p => {
                let statusClass = p.status === 'active' ? 'status-active' : 'status-draft';
                let imgSrc = p.image ? p.image.src : 'https://placehold.co/50';
                
                let invHtml = '<div class="inv-grid-container">';
                if(p.variants) {
                    p.variants.forEach(v => {
                        invHtml += `<div class="inv-item">
                        <span class="inv-label">${v.title}</span>
                        <input type="number" class="inv-input" value="${v.inventory_quantity}" onchange="trackInv(this, '${v.inventory_item_id}')"></div>`;
                    });
                }
                invHtml += '</div>';

                return `<tr>
                    <td class="text-center"><input type="checkbox" class="product-check form-check-input" value="${p.id}"></td>
                    <td class="text-center"><img src="${imgSrc}" class="product-img" onclick="viewImage('${imgSrc}')"></td>
                    <td class="fw-bold fs-7">${p.title}</td>
                    <td>${invHtml}</td>
                    <td class="small font-monospace text-secondary">${p.variants[0]?.sku || '-'}</td>
                    <td class="small text-secondary">${p.product_type || '-'}</td>
                    <td class="text-center"><span class="${statusClass}">${p.status.toUpperCase()}</span></td>
                </tr>`;
            }).join('');
        }

        function selectByStatus(type) {
            document.querySelectorAll('.product-check').forEach(cb => {
                const p = globalProducts.find(item => item.id == cb.value);
                if(!p) return;
                const isDraft = p.status === 'draft';
                const isActive = p.status === 'active';
                const hasStock = p.variants && p.variants.some(v => parseInt(v.inventory_quantity) > 0);
                cb.checked = false;
                if (type === 'all') cb.checked = true;
                else if (type === 'active' && isActive) cb.checked = true;
                else if (type === 'draft' && isDraft) cb.checked = true;
                else if (type === 'draft_stock' && isDraft && hasStock) cb.checked = true;
            });
        }

        function trackInv(el, iid) {
            el.classList.add('inv-dirty');
            pendingInventory[iid] = el.value;
            document.getElementById('btnSaveInventory').style.display = 'inline-block';
        }

        function initUpdateStatus(status) {
            const count = document.querySelectorAll('.product-check:checked').length;
            if(count === 0) return showCustomAlert("Select products first.");

            let msg = `Set ${count} to ${status.toUpperCase()}?`;
            if (status === 'draft') msg += "\n\n‚ö†Ô∏è Inv will be 0!";
            showConfirm(msg, () => updateStatus(status));
        }

        function initDraftAllStore() {
            showConfirm("‚ö†Ô∏è DANGER: Set ALL ACTIVE products to DRAFT & INV 0?", async () => {
                showLoader(true);
                await callAPI('draftAllStore');
                showCustomAlert("Done.");
                showLoader(false);
            });
        }

        function showConfirm(msg, cb) {
            const m = document.getElementById('confirmModal');
            document.getElementById('confirmMessage').innerText = msg;
            document.getElementById('confirmYesBtn').onclick = () => { m.style.display='none'; cb(); };
            m.style.display = 'flex';
        }

        function viewImage(src) { document.getElementById('modalImg').src = src; document.getElementById('imageModal').style.display = 'flex'; }
        function toggleSelectAll() { const c = document.getElementById('selectAll').checked; document.querySelectorAll('.product-check').forEach(cb => cb.checked = c); }
        
        async function callAPI(action, payload={}) {
            try {
                const res = await fetch(GAS_WEB_APP_URL, {
                    method: "POST", body: JSON.stringify({ action, ...payload }),
                    headers: { "Content-Type": "text/plain" }
                });
                return await res.json();
            } catch(e) { 
                showCustomAlert("Error: " + e.message);
                return { error: true }; 
            }
        }
    </script>
</body>
</html>
