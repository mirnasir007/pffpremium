<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Manager</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background-color: #f4f6f8; font-family: sans-serif; }
        .container-fluid { max-width: 100%; padding: 0 30px; }
        
        /* Product Image */
        .product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; transition: transform 0.2s; }
        .product-img:hover { transform: scale(1.1); border-color: #0d6efd; }
        
        /* Status Badges */
        .status-active { color: #198754; font-weight: bold; background: #d1e7dd; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }
        .status-draft { color: #6c757d; font-weight: bold; background: #e2e3e5; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }

        /* Sticky Header */
        .sticky-header-wrapper {
            position: sticky; top: 0; z-index: 1020;
            background-color: #f4f6f8;
            padding-top: 15px; padding-bottom: 10px;
            box-shadow: 0 4px 6px -4px rgba(0,0,0,0.1);
        }

        /* Modals (Image & Confirm) */
        #imageModal, #confirmModal {
            display: none; position: fixed; z-index: 3000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(2px);
            justify-content: center; align-items: center;
        }
        #modalImg { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .close-modal { position: absolute; top: 20px; right: 30px; color: #fff; font-size: 40px; cursor: pointer; }
        
        /* Confirm Box Styling */
        .confirm-box { 
            background: white; padding: 30px; border-radius: 12px; width: 450px; 
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.3s ease;
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Loading & Error */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 2000; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        #error-display { display: none; position: fixed; bottom: 20px; right: 20px; max-width: 400px; z-index: 2100; }
        
        /* Helper Links */
        .helper-link { cursor: pointer; font-size: 0.85rem; text-decoration: none; margin-right: 8px; }
        .helper-link:hover { text-decoration: underline; }

        /* Inventory Input Styles */
        .inv-input { 
            width: 60px; text-align: center; padding: 2px; font-size: 0.9rem; border: 1px solid #ced4da; border-radius: 3px;
        }
        .inv-input:focus { border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25); }
        .inv-dirty { background-color: #fff3cd; border-color: #ffc107; } /* Highlights changed inputs */
        .inv-badge { font-size: 0.8rem; margin-right: 3px; font-weight: bold; color: #444; }
    </style>
</head>
<body>

    <div id="imageModal" onclick="this.style.display='none'">
        <span class="close-modal">&times;</span>
        <img id="modalImg">
    </div>

    <div id="confirmModal">
        <div class="confirm-box">
            <h4 id="modalTitle" class="mb-3 fw-bold text-dark">Confirm Action</h4>
            <p id="confirmMessage" class="text-secondary mb-4 fs-6">Are you sure?</p>
            <div class="d-flex justify-content-center gap-3">
                <button id="confirmCancelBtn" class="btn btn-light border px-4" onclick="closeConfirmModal()">Cancel</button>
                <button id="confirmYesBtn" class="btn btn-primary px-4">Yes, Proceed</button>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="sticky-header-wrapper">
            <div class="d-flex justify-content-between align-items-center mb-2 p-3 bg-white shadow-sm rounded">
                <h4 class="m-0">Shopify Manager <small class="text-muted fs-6">| Advanced</small></h4>
                <div class="d-flex align-items-center gap-2">
                    <button id="btnSaveInventory" class="btn btn-warning btn-sm fw-bold shadow-sm" style="display:none;" onclick="saveInventoryChanges()">
                        üíæ SAVE INVENTORY CHANGES
                    </button>

                    <button class="btn btn-danger btn-sm fw-bold border border-white shadow-sm" onclick="initDraftAllStore()">‚ö†Ô∏è ALL DRAFT (Storewide)</button>
                    <span class="badge bg-primary">External Hosted</span>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body p-3">
                    <div class="row g-3 align-items-end">
                        
                        <div class="col-md-5">
                            <label class="form-label fw-bold small text-muted mb-1">Global Search / Collection</label>
                            
                            <div class="input-group input-group-sm mb-1">
                                <input type="text" id="storeSearch" class="form-control" placeholder="Search Title, SKU, or Type...">
                                <button class="btn btn-primary" type="button" onclick="searchStore()">Search Store</button>
                            </div>

                            <select id="collectionSelect" class="form-select form-select-sm" onchange="loadProducts()">
                                <option value="" selected disabled>-- Or Select Collection --</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label fw-bold small text-muted mb-1">Sort Products</label>
                            <select id="sortSelect" class="form-select form-select-sm" onchange="sortAndRender()">
                                <option value="newest">Date: New to Old</option>
                                <option value="oldest">Date: Old to New</option>
                                <option value="active_first">Status: Active First</option>
                                <option value="draft_first">Status: Draft First</option>
                            </select>
                        </div>

                        <div class="col-md-5 d-flex gap-2 justify-content-end">
                            <button class="btn btn-sm btn-success" onclick="initUpdateStatus('active')">Set Active</button>
                            <button class="btn btn-sm btn-secondary" onclick="initUpdateStatus('draft')">Set Draft</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadProducts()">‚Üª Refresh</button>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-2 align-items-center">
                        <div class="small">
                            <strong>Quick Select: </strong>
                            <span class="helper-link text-primary" onclick="selectByStatus('all')">All</span>
                            <span class="helper-link text-success" onclick="selectByStatus('active')">Active</span>
                            <span class="helper-link text-secondary" onclick="selectByStatus('draft')">Draft</span>
                            <span class="helper-link text-danger" onclick="selectByStatus('none')">None</span>
                        </div>
                        <div class="fw-bold text-muted small">
                            Total: <span id="productCount" class="text-dark">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mt-3 mb-5">
            <div class="card-body p-0">
                <table class="table table-hover table-bordered m-0 align-middle table-sm">
                    <thead class="table-dark text-center">
                        <tr>
                            <th width="40"><input type="checkbox" id="selectAll" class="form-check-input" onclick="toggleSelectAll()"></th>
                            <th width="70">Image</th>
                            <th class="text-start">Product Title</th>
                            <th width="250">Inventory (Variant : Qty)</th> <th width="120">SKU</th>
                            <th width="100">Type</th>
                            <th width="100">Status</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <tr><td colspan="7" class="text-center py-5 text-muted">Select a collection or Search to start.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="error-display" class="alert alert-danger shadow-lg">
        <strong>Error:</strong> <span id="error-text"></span>
        <button class="btn-close ms-2" onclick="this.parentElement.style.display='none'"></button>
    </div>
    <div class="loading-overlay" id="loader">
        <div class="spinner-border text-primary" role="status"></div>
        <h5 class="mt-3" id="loaderText">Processing...</h5>
    </div>

    <script>
        // ******************************************************
        // Insert Your Web App URL Here
        // ******************************************************
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzyfwn3QM5HTtkWACf7V6eto14AMrQmRG2zznKaEXyBNmCodqpuQuagVjhv2BweRhkMeg/exec"; 

        let globalCollections = []; 
        let globalProducts = [];
        let pendingInventory = {}; // To store changes { variantId: newQty }

        window.onload = function() {
            if(!GAS_WEB_APP_URL.includes("/exec")) return showError("Invalid URL! Must end with /exec");
            fetchCollections();
        };

        // --- INVENTORY MANAGEMENT LOGIC ---
        
        function trackInventoryChange(input, variantId) {
            const newVal = input.value;
            // Mark input visually as dirty
            input.classList.add('inv-dirty');
            
            // Store change
            pendingInventory[variantId] = newVal;
            
            // Show Save Button
            document.getElementById('btnSaveInventory').style.display = 'inline-block';
        }

        async function saveInventoryChanges() {
            const updates = Object.keys(pendingInventory).map(vid => {
                return { variantId: vid, quantity: pendingInventory[vid] };
            });

            if(updates.length === 0) return;

            showLoader(true, `Saving ${updates.length} inventory changes...`);
            
            const result = await callAPI('updateInventory', { updates: updates });

            if(result.success) {
                // Update Global Data to reflect changes
                updates.forEach(u => {
                    // Update UI clean state
                    const inputs = document.querySelectorAll(`input[data-vid="${u.variantId}"]`);
                    inputs.forEach(inp => inp.classList.remove('inv-dirty'));
                    
                    // Update memory
                    globalProducts.forEach(p => {
                        if(p.variants) {
                            let v = p.variants.find(v => v.id == u.variantId);
                            if(v) v.inventory_quantity = parseInt(u.quantity);
                        }
                    });
                });
                
                pendingInventory = {}; // Clear pending
                document.getElementById('btnSaveInventory').style.display = 'none';
                showCustomAlert("Inventory Updated Successfully!");
            } else {
                showCustomAlert("Some updates failed. Check console or try again.");
            }
            showLoader(false);
        }

        // --- CUSTOM MODAL LOGIC ---
        function showCustomAlert(message) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('modalTitle').innerText = "Notice";
            document.getElementById('confirmMessage').innerText = message;
            document.getElementById('confirmCancelBtn').style.display = 'none';
            const yesBtn = document.getElementById('confirmYesBtn');
            yesBtn.innerText = "OK";
            yesBtn.onclick = function() { closeConfirmModal(); };
            modal.style.display = 'flex';
        }

        function showCustomConfirm(message, callback) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('modalTitle').innerText = "Confirm Action";
            document.getElementById('confirmMessage').innerText = message;
            document.getElementById('confirmCancelBtn').style.display = 'inline-block';
            const yesBtn = document.getElementById('confirmYesBtn');
            yesBtn.innerText = "Yes, Proceed";
            yesBtn.onclick = function() { modal.style.display = 'none'; callback(); };
            modal.style.display = 'flex';
        }
        function closeConfirmModal() { document.getElementById('confirmModal').style.display = 'none'; }

        // --- BUTTON HANDLERS ---
        function initUpdateStatus(status) {
            const checkboxes = document.querySelectorAll('.product-check:checked');
            if (checkboxes.length === 0) return showCustomAlert("Please select at least one product first.");
            showCustomConfirm(`Set ${checkboxes.length} products to ${status.toUpperCase()}?`, function() { updateStatus(status); });
        }

        function initDraftAllStore() {
            showCustomConfirm("‚ö†Ô∏è WARNING: This sets ALL active products to DRAFT. Are you sure?", function() { executeDraftAllStore(); });
        }

        async function executeDraftAllStore() {
            showLoader(true, "Processing Storewide Draft...");
            const result = await callAPI('draftAllStore');
            if (result.success) {
                showCustomAlert(`Success! ${result.count} products moved to Draft.`);
                const currentCollection = document.getElementById('collectionSelect').value;
                if(currentCollection) loadProducts();
            } else {
                showCustomAlert("Result: " + (result.message || "Unknown"));
            }
            showLoader(false);
        }

        // --- CORE LOGIC ---
        async function searchStore() {
            const query = document.getElementById('storeSearch').value;
            if(!query) return showCustomAlert("Enter search text.");
            document.getElementById('collectionSelect').value = "";
            showLoader(true, "Searching...");
            document.getElementById('productTableBody').innerHTML = '<tr><td colspan="7" class="text-center py-5">Searching...</td></tr>';
            const result = await callAPI('searchStore', { query: query });
            if (result.success && result.products) { globalProducts = result.products; sortAndRender(); } 
            else { renderEmpty("No products found."); }
            showLoader(false);
        }

        async function fetchCollections() {
            showLoader(true, "Loading...");
            const result = await callAPI('getCollections');
            if (result.success) {
                globalCollections = result.collections;
                const select = document.getElementById('collectionSelect');
                globalCollections.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id; opt.text = c.title; select.appendChild(opt);
                });
            }
            showLoader(false);
        }

        async function loadProducts() {
            const collectionId = document.getElementById('collectionSelect').value;
            if (!collectionId) return;
            document.getElementById('storeSearch').value = "";
            pendingInventory = {}; document.getElementById('btnSaveInventory').style.display = 'none'; // Clear pending on load
            showLoader(true, "Loading...");
            const result = await callAPI('getProducts', { collectionId: collectionId });
            if (result.success) { globalProducts = result.products; sortAndRender(); }
            showLoader(false);
        }

        function sortAndRender() {
            const sortMode = document.getElementById('sortSelect').value;
            const tbody = document.getElementById('productTableBody');
            const countSpan = document.getElementById('productCount');
            
            if(globalProducts.length === 0) return renderEmpty("No products found.");

            globalProducts.sort((a, b) => {
                if (sortMode === 'newest') return new Date(b.created_at) - new Date(a.created_at);
                if (sortMode === 'oldest') return new Date(a.created_at) - new Date(b.created_at);
                if (sortMode === 'active_first') return (a.status === b.status) ? 0 : (a.status === 'active' ? -1 : 1);
                if (sortMode === 'draft_first') return (a.status === b.status) ? 0 : (a.status === 'draft' ? -1 : 1);
                return 0;
            });

            tbody.innerHTML = '';
            countSpan.innerText = globalProducts.length;

            globalProducts.forEach(p => {
                let imgSrc = p.image ? p.image.src : 'https://placehold.co/60';
                let statusClass = p.status === 'active' ? 'status-active' : 'status-draft';
                let sku = (p.variants && p.variants[0]) ? p.variants[0].sku : '-';
                let type = p.product_type || '-';

                // --- INVENTORY RENDER LOGIC ---
                let inventoryHtml = '<div class="d-flex flex-wrap gap-2 align-items-center">';
                if(p.variants && p.variants.length > 0) {
                    p.variants.forEach(v => {
                        let label = v.title === 'Default Title' ? '' : `<span class="inv-badge">${v.title}</span>`;
                        inventoryHtml += `<div class="d-flex align-items-center bg-light border rounded px-1">${label}<input type="number" class="inv-input form-control-sm border-0 bg-light" data-vid="${v.id}" value="${v.inventory_quantity}" onchange="trackInventoryChange(this, '${v.id}')"></div>`;
                    });
                }
                inventoryHtml += '</div>';
                // -----------------------------

                let row = `
                    <tr>
                        <td class="text-center"><input type="checkbox" class="product-check form-check-input" value="${p.id}"></td>
                        <td class="text-center"><img src="${imgSrc}" class="product-img" onclick="viewImage('${imgSrc}')"></td>
                        <td class="fw-bold text-dark">${p.title}</td>
                        <td>${inventoryHtml}</td> <td class="small font-monospace text-secondary">${sku}</td>
                        <td class="small text-secondary">${type}</td>
                        <td class="text-center"><span class="${statusClass}">${p.status.toUpperCase()}</span></td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }

        async function updateStatus(newStatus) {
            const checkboxes = document.querySelectorAll('.product-check:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);
            showLoader(true, "Updating...");
            const result = await callAPI('updateStatus', { ids: ids, status: newStatus });
            if (result.success) {
                globalProducts.forEach(p => { if(ids.includes(p.id.toString())) p.status = newStatus; });
                sortAndRender();
            }
            showLoader(false);
        }

        // Helpers
        function viewImage(url) { document.getElementById('modalImg').src = url; document.getElementById('imageModal').style.display = "flex"; }
        function selectByStatus(type) {
            document.querySelectorAll('.product-check').forEach(cb => {
                const row = cb.closest('tr');
                const status = row.querySelector('td:last-child span').innerText.toLowerCase();
                if (type === 'all') cb.checked = true;
                else if (type === 'none') cb.checked = false;
                else if (type === 'active' && status === 'active') cb.checked = true;
                else if (type === 'draft' && status === 'draft') cb.checked = true;
            });
        }

        async function callAPI(action, payload) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); 
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: "POST", body: JSON.stringify({ action, ...payload }),
                    headers: { "Content-Type": "text/plain" }, signal: controller.signal
                });
                clearTimeout(timeoutId);
                return await response.json();
            } catch (error) {
                showError(error.name === 'AbortError' ? "Timeout! Server busy." : error.message);
                return { error: true };
            }
        }

        function showLoader(show, text) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
            if(text) document.getElementById('loaderText').innerText = text;
        }
        function showError(msg) {
            document.getElementById('error-text').innerText = msg;
            document.getElementById('error-display').style.display = 'block';
            setTimeout(() => document.getElementById('error-display').style.display='none', 5000);
        }
        function renderEmpty(msg) {
            document.getElementById('productTableBody').innerHTML = `<tr><td colspan="7" class="text-center py-5 text-muted">${msg}</td></tr>`;
            document.getElementById('productCount').innerText = "0";
        }
        function toggleSelectAll() {
            const main = document.getElementById('selectAll');
            document.querySelectorAll('.product-check').forEach(cb => cb.checked = main.checked);
        }
    </script>
</body>
</html>
