<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify Manager</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background-color: #f4f6f8; font-family: sans-serif; }
        .container-fluid { max-width: 100%; padding: 0 30px; }
        
        /* Product Image */
        .product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; transition: transform 0.2s; }
        .product-img:hover { transform: scale(1.1); border-color: #0d6efd; }
        
        /* Status Badges */
        .status-active { color: #198754; font-weight: bold; background: #d1e7dd; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }
        .status-draft { color: #6c757d; font-weight: bold; background: #e2e3e5; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; }

        /* Sticky Header */
        .sticky-header-wrapper {
            position: sticky; top: 0; z-index: 1020;
            background-color: #f4f6f8;
            padding-top: 15px; padding-bottom: 10px;
            box-shadow: 0 4px 6px -4px rgba(0,0,0,0.1);
        }

        /* Modals */
        #imageModal, #confirmModal {
            display: none; position: fixed; z-index: 3000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(2px);
            justify-content: center; align-items: center;
        }
        #modalImg { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .close-modal { position: absolute; top: 20px; right: 30px; color: #fff; font-size: 40px; cursor: pointer; }
        
        .confirm-box { 
            background: white; padding: 30px; border-radius: 12px; width: 450px; 
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.3s ease;
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Helper Links & Local Filter */
        .helper-link { cursor: pointer; font-size: 0.85rem; text-decoration: none; margin-right: 8px; }
        .helper-link:hover { text-decoration: underline; }
        
        /* Local Filter Input Style */
        .local-filter-container { margin-left: 15px; border-left: 2px solid #ddd; padding-left: 15px; display: inline-flex; align-items: center; }
        #localFilterInput { 
            border: 1px solid #ced4da; border-radius: 4px; padding: 2px 8px; font-size: 0.85rem; width: 200px; transition: border-color 0.15s ease-in-out; 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: 95% center;
        }
        #localFilterInput:focus { border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25); }

        /* =========================================
           INVENTORY GRID STYLE (4 Per Row)
           ========================================= */
        .inv-grid-container { display: flex; flex-wrap: wrap; gap: 4px; width: 100%; }
        .inv-item {
            flex: 0 0 calc(25% - 4px); background: #fff; border: 1px solid #dee2e6; border-radius: 4px;
            padding: 2px; display: flex; align-items: center; justify-content: space-between; overflow: hidden;
        }
        .inv-label {
            font-size: 0.75rem; font-weight: bold; color: #555; margin-left: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 25px; cursor: help;
        }
        .inv-input { 
            width: 32px; text-align: center; border: none; background: #f8f9fa;
            font-size: 0.85rem; font-weight: bold; padding: 1px; margin-left: 2px; border-radius: 2px;
        }
        .inv-input:focus { outline: 2px solid #86b7fe; background: #fff; }
        .inv-dirty { background-color: #fff3cd !important; color: #856404; } 

        /* =========================================
           LOADING BAR STYLE
           ========================================= */
        #ajax-loader-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 4px;
            background-color: #e9ecef; z-index: 9999; display: none; overflow: hidden;
        }
        .bar-indeterminate {
            background-color: #0d6efd; height: 100%; width: 100%;
            animation: indeterminateAnimation 1.5s infinite linear; transform-origin: 0% 50%;
        }
        @keyframes indeterminateAnimation {
            0% { transform:  translateX(0) scaleX(0); }
            40% { transform:  translateX(0) scaleX(0.4); }
            100% { transform:  translateX(100%) scaleX(0.5); }
        }
        #click-blocker {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: transparent; z-index: 9998; display: none; cursor: progress;
        }
        #loading-toast {
            position: fixed; bottom: 20px; right: 20px; z-index: 9999;
            background: #333; color: white; padding: 8px 16px; border-radius: 4px;
            font-size: 0.9rem; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <div id="ajax-loader-bar"><div class="bar-indeterminate"></div></div>
    <div id="click-blocker"></div> 
    <div id="loading-toast">Processing...</div>

    <div id="imageModal" onclick="this.style.display='none'">
        <span class="close-modal">&times;</span>
        <img id="modalImg">
    </div>

    <div id="confirmModal">
        <div class="confirm-box">
            <h4 id="modalTitle" class="mb-3 fw-bold text-dark">Confirm Action</h4>
            <p id="confirmMessage" class="text-secondary mb-4 fs-6">Are you sure?</p>
            <div class="d-flex justify-content-center gap-3">
                <button id="confirmCancelBtn" class="btn btn-light border px-4" onclick="closeConfirmModal()">Cancel</button>
                <button id="confirmYesBtn" class="btn btn-primary px-4">Yes, Proceed</button>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="sticky-header-wrapper">
            <div class="d-flex justify-content-between align-items-center mb-2 p-3 bg-white shadow-sm rounded">
                <h4 class="m-0">Shopify Manager <small class="text-muted fs-6">| Advanced</small></h4>
                <div class="d-flex align-items-center gap-2">
                    <button id="btnSaveInventory" class="btn btn-warning btn-sm fw-bold shadow-sm" style="display:none;" onclick="saveInventoryChanges()">
                        üíæ SAVE INVENTORY CHANGES
                    </button>
                    <button class="btn btn-danger btn-sm fw-bold border border-white shadow-sm" onclick="initDraftAllStore()">‚ö†Ô∏è ALL DRAFT (Storewide)</button>
                    <span class="badge bg-primary">External Hosted</span>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body p-3">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-5">
                            <label class="form-label fw-bold small text-muted mb-1">Global Search / Collection</label>
                            <div class="input-group input-group-sm mb-1">
                                <input type="text" id="storeSearch" class="form-control" placeholder="Search Title, SKU, or Type...">
                                <button class="btn btn-primary" type="button" onclick="searchStore()">Search Store</button>
                            </div>
                            <select id="collectionSelect" class="form-select form-select-sm" onchange="loadProducts()">
                                <option value="" selected disabled>-- Or Select Collection --</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold small text-muted mb-1">Sort Products</label>
                            <select id="sortSelect" class="form-select form-select-sm" onchange="applyLocalFilter()">
                                <option value="newest">Date: New to Old</option>
                                <option value="oldest">Date: Old to New</option>
                                <option value="active_first">Status: Active First</option>
                                <option value="draft_first">Status: Draft First</option>
                            </select>
                        </div>
                        <div class="col-md-5 d-flex gap-2 justify-content-end">
                            <button class="btn btn-sm btn-success" onclick="initUpdateStatus('active')">Set Active</button>
                            <button class="btn btn-sm btn-secondary" onclick="initUpdateStatus('draft')">Set Draft</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadProducts()">‚Üª Refresh</button>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-2 align-items-center">
                        <div class="small d-flex align-items-center">
                            <strong>Quick Select: </strong>
                            <span class="ms-2 helper-link text-primary" onclick="selectByStatus('all')">All</span>
                            <span class="helper-link text-success" onclick="selectByStatus('active')">Active</span>
                            <span class="helper-link text-secondary" onclick="selectByStatus('draft')">Draft</span>
                            <span class="helper-link text-danger" onclick="selectByStatus('none')">None</span>
                            
                            <div class="local-filter-container">
                                <input type="text" id="localFilterInput" placeholder="Filter List (Title, SKU, Type)" onkeyup="applyLocalFilter()" disabled>
                            </div>
                        </div>
                        <div class="fw-bold text-muted small">
                            Total: <span id="productCount" class="text-dark">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mt-3 mb-5">
            <div class="card-body p-0">
                <table class="table table-hover table-bordered m-0 align-middle table-sm">
                    <thead class="table-dark text-center">
                        <tr>
                            <th width="40"><input type="checkbox" id="selectAll" class="form-check-input" onclick="toggleSelectAll()"></th>
                            <th width="60">Image</th>
                            <th class="text-start">Product Title</th>
                            <th width="280">Inventory</th> 
                            <th width="120">SKU</th>
                            <th width="100">Type</th>
                            <th width="80">Status</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <tr><td colspan="7" class="text-center py-5 text-muted">Select a collection or Search to start.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="error-display" class="alert alert-danger shadow-lg" style="display:none; position:fixed; bottom:20px; left:20px; z-index:2100;">
        <strong>Error:</strong> <span id="error-text"></span>
        <button class="btn-close ms-2" onclick="this.parentElement.style.display='none'"></button>
    </div>

    <script>
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzyfwn3QM5HTtkWACf7V6eto14AMrQmRG2zznKaEXyBNmCodqpuQuagVjhv2BweRhkMeg/exec"; 

        let globalCollections = []; 
        let globalProducts = [];
        let filteredProducts = []; 
        let pendingInventory = {}; // Key will now be inventory_item_id

        window.onload = function() {
            if(!GAS_WEB_APP_URL.includes("/exec")) return showError("Invalid URL! Must end with /exec");
            fetchCollections();
        };

        // --- LOADING LOGIC ---
        function showLoader(show, text) {
            const bar = document.getElementById('ajax-loader-bar');
            const blocker = document.getElementById('click-blocker');
            const toast = document.getElementById('loading-toast');
            if (show) {
                bar.style.display = 'block'; blocker.style.display = 'block';
                if(text) { toast.innerText = text; toast.style.display = 'block'; }
            } else {
                bar.style.display = 'none'; blocker.style.display = 'none'; toast.style.display = 'none';
            }
        }

        // --- INVENTORY LOGIC (Tracking by Inventory Item ID) ---
        function trackInventoryChange(input, invItemId) {
            input.classList.add('inv-dirty');
            pendingInventory[invItemId] = input.value;
            document.getElementById('btnSaveInventory').style.display = 'inline-block';
        }

        async function saveInventoryChanges() {
            // Using Inventory Item ID for backend update
            const updates = Object.keys(pendingInventory).map(iid => {
                return { inventoryItemId: iid, quantity: pendingInventory[iid] };
            });
            if(updates.length === 0) return;

            showLoader(true, "Saving Inventory...");
            const result = await callAPI('updateInventory', { updates: updates });

            if(result.success) {
                updates.forEach(u => {
                    const inputs = document.querySelectorAll(`input[data-iid="${u.inventoryItemId}"]`);
                    inputs.forEach(inp => inp.classList.remove('inv-dirty'));
                    
                    // Update globalProducts memory to reflect changes
                    globalProducts.forEach(p => {
                        if(p.variants) {
                            let v = p.variants.find(v => v.inventory_item_id == u.inventoryItemId);
                            if(v) v.inventory_quantity = parseInt(u.quantity);
                        }
                    });
                });
                pendingInventory = {};
                document.getElementById('btnSaveInventory').style.display = 'none';
                showCustomAlert("Inventory Updated Successfully!");
            } else {
                showCustomAlert("Failed. Check if Location ID is set in Shopify.");
            }
            showLoader(false);
        }

        // --- FILTER & RENDER LOGIC ---
        function applyLocalFilter() {
            const term = document.getElementById('localFilterInput').value.toLowerCase();
            if (!term) {
                filteredProducts = [...globalProducts];
            } else {
                filteredProducts = globalProducts.filter(p => {
                    const titleMatch = p.title.toLowerCase().includes(term);
                    const typeMatch = p.product_type && p.product_type.toLowerCase().includes(term);
                    const skuMatch = p.variants.some(v => v.sku && v.sku.toLowerCase().includes(term));
                    return titleMatch || typeMatch || skuMatch;
                });
            }
            sortAndRender();
        }

        function sortAndRender() {
            const sortMode = document.getElementById('sortSelect').value;
            const tbody = document.getElementById('productTableBody');
            const countSpan = document.getElementById('productCount');
            
            if(filteredProducts.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-5 text-muted">No products found.</td></tr>`;
                countSpan.innerText = "0";
                return;
            }

            filteredProducts.sort((a, b) => {
                if (sortMode === 'newest') return new Date(b.created_at) - new Date(a.created_at);
                if (sortMode === 'oldest') return new Date(a.created_at) - new Date(b.created_at);
                if (sortMode === 'active_first') return (a.status === b.status) ? 0 : (a.status === 'active' ? -1 : 1);
                if (sortMode === 'draft_first') return (a.status === b.status) ? 0 : (a.status === 'draft' ? -1 : 1);
                return 0;
            });

            countSpan.innerText = filteredProducts.length;

            const rows = filteredProducts.map(p => {
                let imgSrc = p.image ? p.image.src : 'https://placehold.co/60';
                let statusClass = p.status === 'active' ? 'status-active' : 'status-draft';
                let sku = (p.variants && p.variants[0]) ? p.variants[0].sku : '-';
                let type = p.product_type || '-';

                let inventoryHtml = '<div class="inv-grid-container">';
                if(p.variants && p.variants.length > 0) {
                    p.variants.forEach(v => {
                        let label = v.title === 'Default Title' ? 'Qty' : v.title;
                        // Important: Storing inventory_item_id in data-iid attribute
                        inventoryHtml += `
                            <div class="inv-item" title="${label}">
                                <span class="inv-label">${label}</span>
                                <input type="number" class="inv-input" data-iid="${v.inventory_item_id}" value="${v.inventory_quantity}" onchange="trackInventoryChange(this, '${v.inventory_item_id}')">
                            </div>`;
                    });
                }
                inventoryHtml += '</div>';

                return `
                    <tr>
                        <td class="text-center"><input type="checkbox" class="product-check form-check-input" value="${p.id}"></td>
                        <td class="text-center"><img src="${imgSrc}" class="product-img" onclick="viewImage('${imgSrc}')"></td>
                        <td class="fw-bold text-dark">${p.title}</td>
                        <td style="vertical-align: top;">${inventoryHtml}</td>
                        <td class="small font-monospace text-secondary">${sku}</td>
                        <td class="small text-secondary">${type}</td>
                        <td class="text-center"><span class="${statusClass}">${p.status.toUpperCase()}</span></td>
                    </tr>`;
            }).join('');

            tbody.innerHTML = rows;
        }

        // --- CORE & HELPERS ---
        async function searchStore() {
            const query = document.getElementById('storeSearch').value;
            if(!query) return showCustomAlert("Enter search text.");
            document.getElementById('collectionSelect').value = "";
            document.getElementById('localFilterInput').value = "";
            document.getElementById('localFilterInput').disabled = true;

            showLoader(true, "Searching Store...");
            const result = await callAPI('searchStore', { query: query });
            
            if (result.success && result.products) { 
                globalProducts = result.products; 
                filteredProducts = [...globalProducts];
                sortAndRender(); 
                document.getElementById('localFilterInput').disabled = false;
            } else { 
                globalProducts = []; filteredProducts = [];
                sortAndRender(); 
            }
            showLoader(false);
        }

        async function fetchCollections() {
            showLoader(true, "Loading...");
            const result = await callAPI('getCollections');
            if (result.success) {
                globalCollections = result.collections;
                const select = document.getElementById('collectionSelect');
                globalCollections.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id; opt.text = c.title; select.appendChild(opt);
                });
            }
            showLoader(false);
        }

        async function loadProducts() {
            const collectionId = document.getElementById('collectionSelect').value;
            if (!collectionId) return;
            document.getElementById('storeSearch').value = "";
            
            document.getElementById('localFilterInput').value = "";
            document.getElementById('localFilterInput').disabled = true; 

            pendingInventory = {}; document.getElementById('btnSaveInventory').style.display = 'none';
            showLoader(true, "Loading Products...");
            
            const result = await callAPI('getProducts', { collectionId: collectionId });
            if (result.success) { 
                globalProducts = result.products;
                filteredProducts = [...globalProducts]; 
                sortAndRender(); 
                document.getElementById('localFilterInput').disabled = false; 
            }
            showLoader(false);
        }

        async function updateStatus(newStatus) {
            const checkboxes = document.querySelectorAll('.product-check:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);
            showLoader(true, "Updating Status...");
            const result = await callAPI('updateStatus', { ids: ids, status: newStatus });
            if (result.success) {
                globalProducts.forEach(p => { if(ids.includes(p.id.toString())) p.status = newStatus; });
                applyLocalFilter(); 
            }
            showLoader(false);
        }
        
        // Modals & Utils
        function showCustomAlert(message) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('modalTitle').innerText = "Notice";
            document.getElementById('confirmMessage').innerText = message;
            document.getElementById('confirmCancelBtn').style.display = 'none';
            document.getElementById('confirmYesBtn').innerText = "OK";
            document.getElementById('confirmYesBtn').onclick = function() { closeConfirmModal(); };
            modal.style.display = 'flex';
        }
        function showCustomConfirm(message, callback) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('modalTitle').innerText = "Confirm Action";
            document.getElementById('confirmMessage').innerText = message;
            document.getElementById('confirmCancelBtn').style.display = 'inline-block';
            document.getElementById('confirmYesBtn').innerText = "Yes, Proceed";
            document.getElementById('confirmYesBtn').onclick = function() { modal.style.display = 'none'; callback(); };
            modal.style.display = 'flex';
        }
        function closeConfirmModal() { document.getElementById('confirmModal').style.display = 'none'; }
        function viewImage(url) { document.getElementById('modalImg').src = url; document.getElementById('imageModal').style.display = "flex"; }
        function initUpdateStatus(status) {
            const checkboxes = document.querySelectorAll('.product-check:checked');
            if (checkboxes.length === 0) return showCustomAlert("Please select at least one product.");
            showCustomConfirm(`Set ${checkboxes.length} products to ${status.toUpperCase()}?`, function() { updateStatus(status); });
        }
        function initDraftAllStore() {
            showCustomConfirm("‚ö†Ô∏è WARNING: This sets ALL active products to DRAFT. Are you sure?", function() { executeDraftAllStore(); });
        }
        async function executeDraftAllStore() {
            showLoader(true, "Processing Storewide Draft...");
            const result = await callAPI('draftAllStore');
            if (result.success) {
                showCustomAlert(`Success! ${result.count} products moved to Draft.`);
                const currentCollection = document.getElementById('collectionSelect').value;
                if(currentCollection) loadProducts();
            } else { showCustomAlert("Result: " + (result.message || "Unknown")); }
            showLoader(false);
        }
        function selectByStatus(type) {
            document.querySelectorAll('.product-check').forEach(cb => {
                const row = cb.closest('tr');
                const status = row.querySelector('td:last-child span').innerText.toLowerCase();
                if (type === 'all') cb.checked = true;
                else if (type === 'none') cb.checked = false;
                else if (type === 'active' && status === 'active') cb.checked = true;
                else if (type === 'draft' && status === 'draft') cb.checked = true;
            });
        }
        async function callAPI(action, payload) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); 
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: "POST", body: JSON.stringify({ action, ...payload }),
                    headers: { "Content-Type": "text/plain" }, signal: controller.signal
                });
                clearTimeout(timeoutId);
                return await response.json();
            } catch (error) {
                showError(error.name === 'AbortError' ? "Timeout! Server busy." : error.message);
                return { error: true };
            }
        }
        function showError(msg) { document.getElementById('error-text').innerText = msg; document.getElementById('error-display').style.display = 'block'; setTimeout(() => document.getElementById('error-display').style.display='none', 5000); }
        function toggleSelectAll() { const main = document.getElementById('selectAll'); document.querySelectorAll('.product-check').forEach(cb => cb.checked = main.checked); }
    </script>
</body>
</html>
